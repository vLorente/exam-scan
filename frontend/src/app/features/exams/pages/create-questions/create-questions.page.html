<app-layout>
  <main class="create-questions-page" role="main" aria-labelledby="page-title">
    <div class="container">
      @if (exam(); as currentExam) {
        <header class="page-header">
          <div class="header-content">
            <button
              class="back-button"
              (click)="goBack()"
              aria-label="Volver a la lista de exámenes">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
                <path d="M19 12H5M12 19l-7-7 7-7"/>
              </svg>
              Volver
            </button>

            <div class="header-info">
              <h1 id="page-title" class="page-title">{{ currentExam.title }}</h1>
              <p class="page-description">
                Añade preguntas a tu examen
              </p>
            </div>

            <div class="exam-stats">
              <div class="stat">
                <span class="stat-number">{{ questions().length }}</span>
                <span class="stat-label">Preguntas</span>
              </div>
              <div class="stat">
                <span class="stat-number">{{ totalPoints() }}</span>
                <span class="stat-label">Puntos</span>
              </div>
            </div>
          </div>
        </header>

        <!-- Question Form -->
        <section class="question-form-section" aria-labelledby="form-title">
          <h2 id="form-title" class="section-title">
            {{ editingIndex() !== -1 ? 'Editar Pregunta' : 'Nueva Pregunta' }}
          </h2>

          <form [formGroup]="questionForm" (ngSubmit)="onSubmitQuestion()" class="question-form">
            <div class="form-grid">
              <div class="form-group full-width">
                <label for="questionText" class="form-label">
                  Pregunta *
                </label>
                <textarea
                  id="questionText"
                  formControlName="questionText"
                  class="form-textarea"
                  placeholder="Escribe tu pregunta aquí..."
                  rows="3"
                  [class.error]="questionForm.get('questionText')?.invalid && questionForm.get('questionText')?.touched">
                </textarea>
                @if (questionForm.get('questionText')?.invalid && questionForm.get('questionText')?.touched) {
                  <span class="error-message" role="alert">
                    La pregunta es requerida
                  </span>
                }
              </div>

              <div class="form-group">
                <label for="questionType" class="form-label">
                  Tipo de Pregunta *
                </label>
                <select
                  id="questionType"
                  formControlName="questionType"
                  class="form-select"
                  (change)="onTypeChange()">
                  <option value="multiple_choice">Opción Múltiple</option>
                  <option value="true_false">Verdadero/Falso</option>
                  <option value="short_answer">Respuesta Corta</option>
                </select>
              </div>

              <div class="form-group">
                <label for="points" class="form-label">
                  Puntos *
                </label>
                <input
                  type="number"
                  id="points"
                  formControlName="points"
                  class="form-input"
                  placeholder="5"
                  min="1"
                  max="100"
                  [class.error]="questionForm.get('points')?.invalid && questionForm.get('points')?.touched">
                @if (questionForm.get('points')?.invalid && questionForm.get('points')?.touched) {
                  <span class="error-message" role="alert">
                    Los puntos son requeridos
                  </span>
                }
              </div>

              <!-- Multiple Choice Options -->
              @if (questionForm.get('questionType')?.value === 'multiple_choice') {
                <div class="form-group full-width">
                  <label class="form-label">Opciones *</label>
                  <div class="options-container">
                    @for (option of optionsArray.controls; track $index) {
                      <div class="option-row">
                        <input
                          [formControlName]="$index"
                          class="form-input"
                          [placeholder]="'Opción ' + ($index + 1)"
                          [class.error]="option.invalid && option.touched">
                        <label class="radio-label">
                          <input
                            type="radio"
                            [name]="'correct-answer'"
                            [value]="$index"
                            (change)="setCorrectAnswer($index)"
                            [checked]="correctAnswerIndex() === $index">
                          <span class="radio-custom"></span>
                          Correcta
                        </label>
                        @if (optionsArray.length > 2) {
                          <button
                            type="button"
                            class="remove-option-btn"
                            (click)="removeOption($index)"
                            aria-label="Eliminar opción">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
                              <line x1="18" y1="6" x2="6" y2="18"/>
                              <line x1="6" y1="6" x2="18" y2="18"/>
                            </svg>
                          </button>
                        }
                      </div>
                    }

                    @if (optionsArray.length < 6) {
                      <button
                        type="button"
                        class="add-option-btn"
                        (click)="addOption()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
                          <line x1="12" y1="5" x2="12" y2="19"/>
                          <line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                        Añadir Opción
                      </button>
                    }
                  </div>
                </div>
              }

              <!-- True/False -->
              @if (questionForm.get('questionType')?.value === 'true_false') {
                <div class="form-group">
                  <label class="form-label">Respuesta Correcta *</label>
                  <div class="radio-group">
                    <label class="radio-label">
                      <input
                        type="radio"
                        formControlName="correctAnswer"
                        [value]="true">
                      <span class="radio-custom"></span>
                      Verdadero
                    </label>
                    <label class="radio-label">
                      <input
                        type="radio"
                        formControlName="correctAnswer"
                        [value]="false">
                      <span class="radio-custom"></span>
                      Falso
                    </label>
                  </div>
                </div>
              }

              <!-- Short Answer -->
              @if (questionForm.get('questionType')?.value === 'short_answer') {
                <div class="form-group">
                  <label for="correctAnswer" class="form-label">
                    Respuesta Correcta *
                  </label>
                  <input
                    type="text"
                    id="correctAnswer"
                    formControlName="correctAnswer"
                    class="form-input"
                    placeholder="Respuesta esperada">
                </div>
              }
            </div>

            <div class="form-actions">
              @if (editingIndex() !== -1) {
                <button
                  type="button"
                  class="btn btn-secondary"
                  (click)="cancelEdit()">
                  Cancelar
                </button>
              }

              <button
                type="submit"
                class="btn btn-primary"
                [disabled]="questionForm.invalid">
                {{ editingIndex() !== -1 ? 'Actualizar Pregunta' : 'Añadir Pregunta' }}
              </button>
            </div>
          </form>
        </section>

        <!-- Questions List -->
        @if (questions().length > 0) {
          <section class="questions-list-section" aria-labelledby="questions-title">
            <h2 id="questions-title" class="section-title">
              Preguntas del Examen ({{ questions().length }})
            </h2>

            <div class="questions-list">
              @for (question of questions(); track question.examId) {
                <div class="question-card">
                  <div class="question-header">
                    <span class="question-number">{{ $index + 1 }}</span>
                    <span class="question-type-badge" [class]="'type-' + question.questionType">
                      {{ getTypeLabel(question.questionType) }}
                    </span>
                    <span class="question-points">{{ question.points }} pts</span>
                  </div>

                  <div class="question-content">
                    <h3 class="question-text">{{ question.questionText }}</h3>

                    @if (question.questionType === 'multiple_choice' && question.options) {
                      <ul class="question-options">
                        @for (option of question.options; track $index) {
                          <li [class.correct]="option === question.correctAnswer">
                            {{ option }}
                            @if (option === question.correctAnswer) {
                              <span class="correct-indicator">✓</span>
                            }
                          </li>
                        }
                      </ul>
                    }

                    @if (question.questionType === 'true_false') {
                      <div class="answer-display">
                        <strong>Respuesta: </strong>
                        {{ question.correctAnswer ? 'Verdadero' : 'Falso' }}
                      </div>
                    }

                    @if (question.questionType === 'short_answer') {
                      <div class="answer-display">
                        <strong>Respuesta esperada: </strong>
                        {{ question.correctAnswer }}
                      </div>
                    }
                  </div>

                  <div class="question-actions">
                    <button
                      class="action-btn edit-btn"
                      (click)="editQuestion($index)"
                      aria-label="Editar pregunta">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
                        <path d="M12 20h9M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/>
                      </svg>
                    </button>
                    <button
                      class="action-btn delete-btn"
                      (click)="deleteQuestion($index)"
                      aria-label="Eliminar pregunta">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
                        <polyline points="3,6 5,6 21,6"/>
                        <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                      </svg>
                    </button>
                  </div>
                </div>
              }
            </div>

            <div class="final-actions">
              <button
                class="btn btn-primary btn-large"
                (click)="finishExam()"
                [disabled]="questions().length === 0">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
                  <polyline points="20,6 9,17 4,12"/>
                </svg>
                Finalizar Examen
              </button>
            </div>
          </section>
        }
      }
    </div>
  </main>
</app-layout>
